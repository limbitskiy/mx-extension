(function () {
	'use strict';

	console.log("page reload at ",Date.now());i();async function i(){await chrome.alarms.create("task-update",{periodInMinutes:6e4/6e4/2});const{settings:e}=await chrome.storage.local.get("settings");e?console.log("regular entry"):(console.log("first entry"),l()),c();}async function c(){await s({key:"ext_read_tasks"});}async function l(){const e={key:"ext_init",data:{timezone:Intl.DateTimeFormat().resolvedOptions().timeZone,browser_language:navigator.language}},t=await s(e);console.log("\u{1F680} ~ firstEntry ~ result:",t);}async function s(e){try{const t=await fetch("https://api-dev.tapsmart.io/main",{method:"POST",headers:{"Content-Type":"application/json;charset=utf-8"},body:JSON.stringify(e)}),{service:o,data:a}=await t.json();return o&&await chrome.storage.local.set({service:o}),a.folders&&await chrome.storage.local.set({folders:a.folders}),a.tasks&&await chrome.storage.local.set({tasks:a.tasks}),a}catch(t){console.error(t);}}async function d(){const{tasks:e}=await chrome.storage.local.get("tasks");!e||(e.forEach((t,o,a)=>{console.log(t),"lastUpdated"in t?t.lastUpdated===300?(u(t),a[o].lastUpdated=t.period):t.lastUpdated-=6e4/1e3:a[o].lastUpdated=t.period;}),await chrome.storage.local.set({tasks:e}));}async function u(e){console.log("executing task");const o=await(await fetch(e.url)).text(),a={key:"ext_update_tasks",data:{taskId:e.id,url:e.url,html:o}},{status:n}=await s(a);n||console.error("Error when executing task");}chrome.runtime.onMessage.addListener((e,t,o)=>{console.log(e);const{action:a,payload:n}=e;if(a==="make_request")return s(n).then(r=>o(r)).catch(r=>o({error:r.message})),!0});chrome.runtime.onStartup.addListener(()=>{console.log("browser startup",Date.now()),chrome.alarms.create("updateTasks",{periodInMinutes:.5});});chrome.runtime.onInstalled.addListener(function(){console.log("installed startup",Date.now()),chrome.alarms.create("updateTasks",{periodInMinutes:.5});});chrome.alarms.onAlarm.addListener(e=>{e.name==="task-update"&&(console.log("Updating sources.."),d());});

})();
